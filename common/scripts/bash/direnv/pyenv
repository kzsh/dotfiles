#!/usr/bin/env bash

. $COMMON_SCRIPTS/bash/utils/script_dir.sh

SCRIPT_DIR="$EXEC_DIR"
DIRENV_DIR="$SCRIPT_DIR"
PYTHON_VERSION="$(cat "$DIRENV_DIR/.python-version")"
VIRTUAL_ENVIRONMENT="$(cat "$DIRENV_DIR/.virtual-environment")"

virtual_env_exists() {
  pyenv versions | grep -q full_virtualenv_path
}

create_missing_virtual_environment() {
  pyenv virtualenv $PYTHON_VERSION $VIRTUAL_ENVIRONMENT
}

full_virtualenv_path() {
 echo "$PYTHON_VERSION/env/$VIRTUAL_ENVIRONMENT"
}

is_python_version_installed() {
  pyenv versions | grep -q "^$PYTHON_VERSION\$"
}

install_missing_python_version() {
  pyenv install "$PYTHON_VERSION"
}

export PYENV_VIRTUALENV_DISABLE_PROMPT=1
export PYENV_ROOT=$HOME/.pyenv
export PATH="$PYENV_ROOT/bin:$PATH"

eval "$(pyenv init -)"

if ! virtual_env_exists; then
  echo "RUN: Install $PYTHON_VERSION"
  create_missing_virtual_environment
  echo "RUN COMPLETE: Install $PYTHON_VERSION"
else
  echo "SKIP: install.  pyenv virtualenv $VIRTUAL_ENVIRONMENT is already installed"
fi

pyenv activate "$VIRTUAL_ENVIRONMENT"
